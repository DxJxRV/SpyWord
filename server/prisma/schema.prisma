// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// Modelo de Palabras del juego
model Word {
  id        Int      @id @default(autoincrement())
  word      String   @unique @db.VarChar(100)
  category  String   @db.VarChar(50)
  weight    Int      @default(100)
  is_active Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("words")
  @@index([is_active, weight])
  @@index([category])
}

// Modelo de Sugerencias de usuarios
model WordSuggestion {
  id          Int                    @id @default(autoincrement())
  word        String                 @db.VarChar(100)
  category    String?                @db.VarChar(50)
  status      WordSuggestionStatus   @default(PENDING)
  submittedAt DateTime               @default(now()) @map("submitted_at")

  @@map("word_suggestions")
  @@index([status])
}

// Enum para el estado de las sugerencias
enum WordSuggestionStatus {
  PENDING
  APPROVED
  REJECTED
}

// Modelo para Modos de Juego Especiales
model GameMode {
  id             Int      @id @default(autoincrement())
  name           String   @unique @db.VarChar(100)
  description    String?  @db.Text
  type           String   @default("word") @db.VarChar(20) // 'word' | 'image' | 'hybrid'
  isActive       Boolean  @default(true) @map("is_active")

  // Legacy field para compatibilidad (modos antiguos)
  wordList       String?  @db.Text @map("word_list") // JSON string de palabras (deprecated)

  // Nuevo sistema de items genérico
  items          Json?    // Array de items: [{label, imageUrl?, weight}]

  // Configuración visual del botón del modo
  buttonImage    String?  @db.VarChar(500) @map("button_image") // URL de imagen
  buttonColor    String?  @db.VarChar(7) @map("button_color") // Color hex (#RRGGBB)
  buttonGradient Json?    @map("button_gradient") // {from: "#xxx", to: "#yyy"}

  isDailyMode       Boolean  @default(false) @map("is_daily_mode") // Solo uno debe ser true
  isFeaturedOnHome  Boolean  @default(false) @map("is_featured_on_home") // Aparece en botón del home
  featuredOrder     Int?     @map("featured_order") // Orden de aparición (1-3) en home
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  @@map("game_modes")
  @@index([isActive, isDailyMode])
  @@index([type])
  @@index([isFeaturedOnHome, featuredOrder])
}

// Modelo para almacenar imágenes subidas al servidor
model ModeImage {
  id           Int      @id @default(autoincrement())
  filename     String   @unique @db.VarChar(255) // Nombre del archivo en /uploads
  originalName String   @db.VarChar(255) @map("original_name") // Nombre original
  mimeType     String   @db.VarChar(50) @map("mime_type") // image/jpeg, image/png
  size         Int      // Tamaño en bytes
  path         String   @db.VarChar(500) // Ruta relativa: uploads/xxxx.jpg
  url          String   @db.VarChar(500) // URL completa para acceder
  createdAt    DateTime @default(now()) @map("created_at")

  @@map("mode_images")
  @@index([filename])
}

// Modelo de Usuario para autenticación y premium
model User {
  id              String    @id @default(uuid())
  email           String    @unique @db.VarChar(255)
  name            String?   @db.VarChar(255)
  googleId        String?   @unique @map("google_id") @db.VarChar(255)
  password        String?   @db.VarChar(255) // Para autenticación con email (bcrypt hash)
  profilePicture  String?   @map("profile_picture") @db.VarChar(500) // URL de la foto de perfil (Google)
  isPremium       Boolean   @default(false) @map("is_premium") // CRUCIAL para anuncios y Premium Pass
  premiumExpiresAt DateTime? @map("premium_expires_at") // Fecha de expiración del premium
  isAdmin         Boolean   @default(false) @map("is_admin") // Permisos de administrador
  dailyRouletteTokens Int   @default(1) @map("daily_roulette_tokens") // Fichas para ruleta diaria (se resetea diario)
  premiumRouletteTokens Int @default(0) @map("premium_roulette_tokens") // Fichas para ruleta premium
  lastDailyTokenReset DateTime? @map("last_daily_token_reset") // Última vez que se resetearon tokens diarios
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  rouletteSpins   RouletteSpins[]

  @@map("users")
  @@index([googleId])
  @@index([isPremium])
  @@index([email])
  @@index([isAdmin])
}

// Modelo para trackear spins de la ruleta
model RouletteSpins {
  id            Int      @id @default(autoincrement())
  userId        String   @map("user_id")
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rouletteType  String   @db.VarChar(20) @map("roulette_type") // 'daily' | 'premium'
  prize         String   @db.VarChar(50) // 'nothing' | '10min' | '30min' | '1day' | '1week' | '3days' | '7days' | '1month' | 'lifetime'
  prizeMinutes  Int?     @map("prize_minutes") // Minutos de premium ganados (null si es nothing o lifetime)
  spunAt        DateTime @default(now()) @map("spun_at")

  @@map("roulette_spins")
  @@index([userId, spunAt])
  @@index([spunAt])
  @@index([rouletteType])
}
